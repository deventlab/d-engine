syntax = "proto3";
package raft.common;

// Basic definitions shared across modules
message LogId {
  uint64 term = 1;
  uint64 index = 2;
}

// Raft log entry
message Entry {
  uint64 index = 1;
  uint64 term = 2;
  EntryPayload payload = 3;
}

// Log entry payload
message EntryPayload {
  oneof payload {
    Noop noop = 1;       // No operation (internal to the protocol)
    bytes command = 2;    // Business write operation
    MembershipChange config = 3;  // Cluster configuration change
  }
}

// Internal operation of the protocol
message Noop {} // Empty structure

// Cluster configuration change
message MembershipChange {
  oneof change {
    AddNode add_node = 1;
    RemoveNode remove_node = 2;
    PromoteLearner promote = 3;
    BatchPromote batch_promote = 4;
  }
}

message AddNode {
  uint32 node_id = 1;
  string address = 2;
}


message RemoveNode {
  uint32 node_id = 1;
}

message PromoteLearner {
  uint32 node_id = 1;
  NodeStatus status = 2;
}

message BatchPromote{
  repeated uint32 node_ids = 1;
  NodeStatus new_status = 2;
}

enum NodeStatus {
    // Initial joining process
    JOINING = 0;        // New node, catching up with logs
    SYNCING = 1;        // Start syncing with leader committed logs

    // Running status
    ACTIVE = 2;         // Formal voting member
    STAND_BY = 3;       // Disaster recovery ready node (data has been synchronized)

    // Offline process
    DRAINING = 4;       // Prepare to go offline (not accepting new requests, transfer data)
    RETIRING = 5;       // Retiring (data migration completed)
}

message SnapshotEntry {
    bytes key = 1;
    bytes value = 2;
}

message SnapshotMeta {
    uint64 versionHigh = 1;
    uint64 versionLow = 2;
    uint64 createdAtHigh = 3;
    uint64 createdAtLow = 4;
    uint32 authorId = 5;
    LogId lastIncluded = 6;
}

message Snapshot {
    SnapshotMeta meta = 1;
    repeated SnapshotEntry data = 2;
}
