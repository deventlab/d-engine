name: Performance Benchmarks

# Run benchmarks on a schedule and for important changes
on:
  # Run weekly on Sunday at 2 AM UTC
  schedule:
    - cron: '0 2 * * 0'

  # Allow manual triggering for on-demand performance testing
  workflow_dispatch:

  # Run on pushes to main branch that affect performance-critical code
  push:
    branches:
      - main
    paths:
      - 'd-engine-server/src/storage/**'
      - 'd-engine-server/benches/**'
      - 'd-engine-core/src/**'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: full

jobs:
  benchmark:
    name: Run Performance Benchmarks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for performance comparison

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.88.0

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          # Cache key includes benchmark to avoid interference with test cache
          key: benchmark-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Run benchmarks
        run: |
          echo "========================================="
          echo "Running d-engine Performance Benchmarks"
          echo "========================================="
          echo ""
          echo "Performance Targets:"
          echo "  â€¢ Without TTL: < 10ns overhead"
          echo "  â€¢ With TTL passive check: < 50ns overhead"
          echo "  â€¢ Piggyback cleanup: < 1ms"
          echo ""

          # Run benchmarks and save output
          cargo bench --package d-engine-server -- --output-format bencher | tee benchmark_output.txt

          echo ""
          echo "âœ… Benchmarks completed successfully"

      - name: Store benchmark results
        uses: benchmark-action/github-action-benchmark@v1
        with:
          name: D-Engine Rust Benchmarks
          tool: 'cargo'
          output-file-path: benchmark_output.txt
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          # Alert if performance degrades by more than 10%
          alert-threshold: '110%'
          comment-on-alert: true
          fail-on-alert: false
          # Store results in gh-pages branch
          gh-pages-branch: gh-pages
          benchmark-data-dir-path: dev/bench

      - name: Upload detailed results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            target/criterion/
            benchmark_output.txt
          retention-days: 30

      - name: Performance summary
        run: |
          echo "========================================="
          echo "Performance Benchmark Summary"
          echo "========================================="
          echo ""
          echo "ðŸ“Š Detailed results have been uploaded as artifacts"
          echo "ðŸ“ˆ Historical trends available at: https://$(echo ${{ github.repository }} | sed 's/\//.github.io\//').io/dev/bench/"
          echo ""
          echo "To view detailed HTML reports locally:"
          echo "  1. Download the artifact"
          echo "  2. Open target/criterion/report/index.html in your browser"
          echo ""
          echo "âœ… Performance monitoring complete"
