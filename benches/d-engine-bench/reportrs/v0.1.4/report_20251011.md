# **d-engine Benchmark Report (v0.1.4)**

**Important Notice**

‚úÖ This report is based on **d-engine v0.1.4**, featuring new three-tier read consistency levels and performance optimizations.

üÜï **New in v0.1.4**: Lease-based reads (strong consistency with optimized performance)

---

## **Test Environment**

**Hardware**

Apple Mac mini (M2 Chip)

- 8-core CPU (4 performance + 4 efficiency cores)
- 16GB Unified Memory
- All nodes and benchmarks running on a single machine

**Software Versions**

- d-engine: v0.1.4
- etcd: 3.5.x (official benchmark tool)

**Test Configuration**

| **Parameter**  | **Write Tests** | **Read Tests** |
| -------------- | --------------- | -------------- |
| Key Size       | 8B              | 8B             |
| Value Size     | 256B            | -              |
| Total Requests | 10,000          | 100,000        |
| Connections    | 1/10            | 200            |
| Clients        | 1/100           | 1,000          |

**Persistence Settings**

- **MemFirst + Batch Flush** (threshold=1000, interval=100ms)
- Snapshot enabled with default parameters
- 3-node cluster (all co-located on single machine)

---

## **Performance Results (d-engine v0.1.4)**

### Write Performance

| **Test Case**                      | **Throughput** | **Avg Latency** | **p50**  | **p90**  | **p99**  | **p99.9** |
| ---------------------------------- | -------------- | --------------- | -------- | -------- | -------- | --------- |
| **Write ‚Äì 1 conn / 1 client**      | 574 ops/s      | 1,744 Œºs        | 1,648 Œºs | 2,114 Œºs | 3,330 Œºs | 10,767 Œºs |
| **Write ‚Äì 10 conns / 100 clients** | 5,501 ops/s    | 1,816 Œºs        | 1,950 Œºs | 2,251 Œºs | 2,844 Œºs | 3,213 Œºs  |

### Read Performance (100K requests, 200 conns, 1000 clients)

| **Consistency Level**                            | **Throughput** | **Avg Latency** | **p50**   | **p90**   | **p99**   | **p99.9** |
| ------------------------------------------------ | -------------- | --------------- | --------- | --------- | --------- | --------- |
| **Linearizable (L)** ‚Äì Full quorum reads         | 8,981 ops/s    | 22,457 Œºs       | 21,287 Œºs | 28,535 Œºs | 48,959 Œºs | 69,439 Œºs |
| **Lease-based (S)** ‚Äì üÜï Strong w/ lease         | 62,323 ops/s   | 3,229 Œºs        | 2,931 Œºs  | 5,361 Œºs  | 8,579 Œºs  | 17,727 Œºs |
| **Eventual (E)** ‚Äì Highest performance, stale OK | 68,567 ops/s   | 2,965 Œºs        | 1,637 Œºs  | 6,133 Œºs  | 25,039 Œºs | 55,039 Œºs |

---

## **Version Comparison: v0.1.3 vs v0.1.4**

**Important Note**: v0.1.3's `--consistency=s` was actually eventual consistency, equivalent to v0.1.4's `--consistency=e`. The new `--consistency=s` in v0.1.4 is lease-based strong consistency.

### Write Performance Comparison

| **Test Case**                      | **Metric**  | **v0.1.3**  | **v0.1.4**  | **Change**   | **Notes**                         |
| ---------------------------------- | ----------- | ----------- | ----------- | ------------ | --------------------------------- |
| **Write ‚Äì 1 conn / 1 client**      | Throughput  | 358 ops/s   | 574 ops/s   | ‚¨ÜÔ∏é **+60%** | Significant WAL & batching tuning |
|                                    | Avg Latency | 2,789 Œºs    | 1,744 Œºs    | ‚¨áÔ∏é **-37%** |                                   |
|                                    | p99 Latency | 5,719 Œºs    | 3,330 Œºs    | ‚¨áÔ∏é **-42%** |                                   |
| **Write ‚Äì 10 conns / 100 clients** | Throughput  | 4,089 ops/s | 5,501 ops/s | ‚¨ÜÔ∏é **+35%** | Better concurrency handling       |
|                                    | Avg Latency | 2,443 Œºs    | 1,816 Œºs    | ‚¨áÔ∏é **-26%** |                                   |
|                                    | p99 Latency | 7,511 Œºs    | 2,844 Œºs    | ‚¨áÔ∏é **-62%** | Major tail latency improvement    |

### Read Performance Comparison

| **Consistency Level**                | **Metric**  | **v0.1.3**   | **v0.1.4**   | **Change**   | **Notes**                                  |
| ------------------------------------ | ----------- | ------------ | ------------ | ------------ | ------------------------------------------ |
| **Linearizable (L)**                 | Throughput  | 8,295 ops/s  | 8,981 ops/s  | ‚¨ÜÔ∏é **+8%**  | Consistent despite higher concurrency      |
| (10 conns, 100 clients vs 200/1000)  | Avg Latency | 1,203 Œºs     | 22,457 Œºs    | ‚¨ÜÔ∏é          | Higher due to 10√ó client concurrency       |
| **Lease-based (S)** üÜï               | Throughput  | N/A          | 62,323 ops/s | **NEW**      | New feature in v0.1.4                      |
|                                      | Avg Latency | N/A          | 3,229 Œºs     | **NEW**      | Strong consistency with lease optimization |
| **Eventual (E)**                     | Throughput  | 39,938 ops/s | 68,567 ops/s | ‚¨ÜÔ∏é **+72%** | Major improvement                          |
| (v0.1.3 used `-s`, v0.1.4 uses `-e`) | Avg Latency | 249 Œºs       | 2,965 Œºs     | ‚¨ÜÔ∏é          | Higher due to 10√ó client concurrency       |

**Concurrency Difference**: v0.1.3 read tests used 10 conns / 100 clients, while v0.1.4 uses 200 conns / 1000 clients (10√ó higher). This explains higher absolute latency in v0.1.4 despite better throughput.

---

## **Performance Comparison: d-engine v0.1.4 vs etcd 3.5**

### Write Performance

| **Test Case**            | **Metric**  | **d-engine v0.1.4** | **etcd 3.5** | **Advantage**                |
| ------------------------ | ----------- | ------------------- | ------------ | ---------------------------- |
| **Basic Write**          | Throughput  | 574 ops/s           | 158 ops/s    | ‚úÖ **3.6√ó faster**           |
| (1 connection, 1 client) | Avg Latency | 1,744 Œºs            | 6,300 Œºs     | ‚úÖ **72% lower latency**     |
|                          | p99 Latency | 3,330 Œºs            | 16,700 Œºs    | ‚úÖ **80% lower p99**         |
| **High Concurrency**     | Throughput  | 5,501 ops/s         | 5,439 ops/s  | ‚úÖ **Slightly faster** (+1%) |
| (10 conns, 100 clients)  | Avg Latency | 1,816 Œºs            | 18,300 Œºs    | ‚úÖ **90% lower latency**     |
|                          | p99 Latency | 2,844 Œºs            | 32,400 Œºs    | ‚úÖ **91% lower p99**         |

### Read Performance

| **d-engine Consistency** | **etcd Equivalent**        | **Metric**  | **d-engine v0.1.4** | **etcd 3.5**  | **Comparison**                     |
| ------------------------ | -------------------------- | ----------- | ------------------- | ------------- | ---------------------------------- |
| **Linearizable (L)**     | ‚ùå **Not Supported**       | Throughput  | 8,981 ops/s         | N/A           | d-engine unique: full quorum reads |
| (Full quorum reads)      |                            | Avg Latency | 22,457 Œºs           | N/A           | Strongest consistency guarantee    |
|                          |                            | p99 Latency | 48,959 Œºs           | N/A           | Trade-off for absolute consistency |
| **Lease-based (S)** üÜï   | ‚úÖ **Linearizable** (`-l`) | Throughput  | 62,323 ops/s        | 85,904 ops/s  | ‚ö†Ô∏è **73% of etcd**                 |
| (Strong w/ lease)        | (ReadIndex + lease)        | Avg Latency | 3,229 Œºs            | 1,100 Œºs      | ‚ö†Ô∏è Higher due to 10√ó concurrency   |
|                          |                            | p99 Latency | 8,579 Œºs            | 3,200 Œºs      | ‚ö†Ô∏è Higher concurrency offset       |
| **Eventual (E)**         | ‚úÖ **Serializable** (`-s`) | Throughput  | 68,567 ops/s        | 124,631 ops/s | ‚ö†Ô∏è **55% of etcd**                 |
| (Stale reads OK)         | (Local reads)              | Avg Latency | 2,965 Œºs            | 700 Œºs        | ‚ö†Ô∏è Higher due to 10√ó concurrency   |
|                          |                            | p99 Latency | 25,039 Œºs           | 2,800 Œºs      | ‚ö†Ô∏è Need tail latency optimization  |

**Important Notes**:

1. **etcd does NOT support full quorum linearizable reads** - etcd's "linearizable" mode uses ReadIndex with lease mechanism
2. **d-engine's Lease-based (S)** is comparable to **etcd's Linearizable** (both use lease-based strong consistency)
3. **d-engine's Eventual (E)** is comparable to **etcd's Serializable** (both read local data)
4. **d-engine's Linearizable (L)** is unique - provides strongest consistency via full quorum reads (no etcd equivalent)
5. **Concurrency difference**: d-engine tests use 200 conns / 1000 clients vs etcd's 10 conns / 100 clients (10√ó higher)

---

## **Key Findings**

### ‚úÖ **Major Strengths**

1. **Write Performance Leadership**
   - **3.6√ó faster** than etcd in single-client scenarios
   - **90% lower latency** in high-concurrency writes
   - **62% better p99 tail latency** for high-concurrency writes

2. **Three-Tier Read Consistency** üÜï
   - **Linearizable (L)**: Full quorum, strongest guarantees
   - **Lease-based (S)**: Strong consistency with 7√ó better throughput than linearizable
   - **Eventual (E)**: Maximum performance for stale-tolerant workloads

3. **Latency Improvements vs v0.1.3**
   - Write latency reduced by 26-37%
   - Write p99 latency reduced by 42-62%

### ‚ö†Ô∏è **Areas for Improvement**

1. **Lease-based Read Performance** (comparable to etcd Linearizable)
   - 73% of etcd's throughput (62K vs 86K ops/s)
   - Higher latency partially due to 10√ó concurrency difference
   - Room for optimization in lease-based read path

2. **Read Tail Latency**
   - p99.9 latency spikes significantly under high concurrency
   - Eventual reads show 55ms p99.9 (vs etcd's 2.8ms at lower concurrency)

3. **Eventual Read Throughput**
   - 68K ops/s vs etcd's 124K ops/s
   - Gap partially due to higher test concurrency, but room for improvement

### üìà **v0.1.4 Highlights**

1. **+60% single-client write throughput** (358 ‚Üí 574 ops/s)
2. **+35% high-concurrency write throughput** (4,089 ‚Üí 5,501 ops/s)
3. **+72% eventual read throughput** (39,938 ‚Üí 68,567 ops/s)
4. **üÜï Lease-based reads**: 62K ops/s with strong consistency guarantees

---

## **Recommendations**

### **Use d-engine v0.1.4 for:**

- ‚úÖ **Write-heavy workloads** requiring low latency (<2ms avg, <3ms p99)
- ‚úÖ **High-concurrency writes** where you need better performance than etcd
- ‚úÖ **Applications needing strongest consistency** (full quorum linearizable reads - etcd doesn't support)
- ‚úÖ **Applications needing flexible consistency** (full quorum / lease-based / eventual)
- ‚úÖ **Latency-sensitive write applications** where write tail latency matters

### **Consider etcd for:**

- ‚ö†Ô∏è **Read-heavy workloads** requiring maximum read throughput (>100K ops/s)
- ‚ö†Ô∏è **Applications needing <1ms read latency** at high scale
- ‚ö†Ô∏è **Workloads where lease-based consistency is sufficient** (etcd's linearizable mode)

### **Optimal Consistency Strategy:**

- **Absolute strongest consistency**: Use Linearizable (L) - full quorum reads (unique to d-engine)
- **Strong consistency with performance**: Use Lease-based (S) - 62K ops/s, comparable to etcd linearizable
- **Maximum read performance**: Use Eventual (E) - 68K ops/s when stale data is acceptable

**Note**: If you don't need full quorum linearizable reads (which etcd doesn't provide), d-engine's Lease-based mode (S) offers similar guarantees to etcd's linearizable mode with competitive performance.

---

## **Test Commands**

### d-engine v0.1.4 Tests

```bash
# Write Performance Test, Single Client
./target/release/d-engine-bench  \
    --endpoints http://127.0.0.1:9081 \
    --endpoints http://127.0.0.1:9082 \
    --endpoints http://127.0.0.1:9083 \
    --conns 1 --clients 1 --sequential-keys \
    --total 10000 --key-size 8 --value-size 256 \
    put

# Write Performance Test, High Concurrency
./target/release/d-engine-bench  \
    --endpoints http://127.0.0.1:9081 \
    --endpoints http://127.0.0.1:9082 \
    --endpoints http://127.0.0.1:9083 \
    --conns 10 --clients 100 --sequential-keys \
    --total 10000 --key-size 8 --value-size 256 \
    put

# Linearizable Read (Full quorum)
./target/release/d-engine-bench \
    --endpoints http://127.0.0.1:9081 \
    --endpoints http://127.0.0.1:9082 \
    --endpoints http://127.0.0.1:9083 \
    --conns 200 --clients 1000 --sequential-keys \
    --total 100000 --key-size 8 \
    range --consistency l

# Lease-based Read (Strong with lease optimization) üÜï
./target/release/d-engine-bench \
    --endpoints http://127.0.0.1:9081 \
    --endpoints http://127.0.0.1:9082 \
    --endpoints http://127.0.0.1:9083 \
    --conns 200 --clients 1000 --sequential-keys \
    --total 100000 --key-size 8 \
    range --consistency s

# Eventual Consistency Read (Highest performance)
./target/release/d-engine-bench \
    --endpoints http://127.0.0.1:9081 \
    --endpoints http://127.0.0.1:9082 \
    --endpoints http://127.0.0.1:9083 \
    --conns 200 --clients 1000 --sequential-keys \
    --total 100000 --key-size 8 \
    range --consistency e
```

### etcd 3.5 Tests

```bash
export ENDPOINTS=http://0.0.0.0:2380,http://0.0.0.0:2381,http://0.0.0.0:2382

# Write Performance Test, Single Client
benchmark \
  --endpoints=${ENDPOINTS} --target-leader \
  --conns=1 --clients=1 \
  put --key-size=8 --sequential-keys --total=10000 --val-size=256

# Write Performance Test, High Concurrency
benchmark \
  --endpoints=${ENDPOINTS} --target-leader \
  --conns=10 --clients=100 \
  put --key-size=8 --sequential-keys --total=10000 --val-size=256

# Linearizable Read
benchmark \
  --endpoints=${ENDPOINTS} \
  --conns=10 --clients=100 \
  range key_ --consistency=l --total=10000

# Serializable Read
benchmark \
  --endpoints=${ENDPOINTS} \
  --conns=10 --clients=100 \
  range key_ --consistency=s --total=10000
```

---

## **Raw Benchmark Data (Averaged from 2 runs)**

### Write - 1 conn / 1 client

- **Throughput**: 574 ops/s (avg: 596, 552)
- **Latency**: Avg 1,744 Œºs (1,677, 1,810) | p50 1,648 | p90 2,114 | p99 3,330 | p99.9 10,767

### Write - 10 conns / 100 clients

- **Throughput**: 5,501 ops/s (avg: 5,493, 5,510)
- **Latency**: Avg 1,816 Œºs (1,819, 1,813) | p50 1,950 | p90 2,251 | p99 2,844 | p99.9 3,213

### Linearizable Read (L) - 200 conns / 1000 clients / 100K requests

- **Throughput**: 8,981 ops/s (avg: 9,853, 8,108)
- **Latency**: Avg 22,457 Œºs (20,276, 24,638) | p50 21,287 | p90 28,535 | p99 48,959 | p99.9 69,439

### Lease-based Read (S) üÜï - 200 conns / 1000 clients / 100K requests

- **Throughput**: 62,323 ops/s (avg: 67,806, 56,839)
- **Latency**: Avg 3,229 Œºs (2,946, 3,511) | p50 2,931 | p90 5,361 | p99 8,579 | p99.9 17,727

### Eventual Read (E) - 200 conns / 1000 clients / 100K requests

- **Throughput**: 68,567 ops/s (avg: 77,863, 59,270)
- **Latency**: Avg 2,965 Œºs (2,562, 3,367) | p50 1,637 | p90 6,133 | p99 25,039 | p99.9 55,039

---

## **Conclusion**

**d-engine v0.1.4** represents a significant milestone with:

- ‚úÖ **Excellent write performance**: 3.6√ó faster than etcd with 90% lower latency
- ‚úÖ **Production-ready write path**: Matches/exceeds etcd in all write scenarios
- ‚úÖ **Unique strongest consistency**: Full quorum linearizable reads (not available in etcd)
- ‚úÖ **Flexible read consistency**: Three-tier model for different use cases
- ‚úÖ **üÜï Lease-based reads**: Strong consistency with good performance (62K ops/s, 73% of etcd)
- ‚ö†Ô∏è **Read throughput**: Lower than etcd in lease-based and eventual modes

**Key Differentiator**: d-engine offers **full quorum linearizable reads** for applications requiring the absolute strongest consistency guarantees, which etcd does not support. For use cases where lease-based consistency is sufficient (like etcd's linearizable mode), both systems offer comparable guarantees.

**Next Development Priorities:**

1. Optimize lease-based and eventual read paths to match etcd throughput
2. Reduce read tail latency (p99.9) under high concurrency
3. Improve concurrent read performance (currently tested at 10√ó higher concurrency than etcd)
4. Conduct distributed multi-machine benchmarks

---

_Report generated: 2025-01-11_
_d-engine version: v0.1.4_
_Test environment: Apple M2 Mac mini (16GB), single-machine 3-node cluster_
